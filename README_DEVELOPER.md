# Development information

## Overview

Two Docker images are distributed to teams: the ARIAC server image (runs the simulation), and the competitor base image (has ARIAC but not Gazebo installed) that team's will build their Docker image on top of.
These are generated by the `prepare_team_system.bash` script and distributed via Dockerhub (see "Releasing a new version of ariac2 Docker images" below).

In ARIAC 2017, both ROS Indigo and ROS Kinetic were supported.
For that reason, the dockerfile templates used to create the images are named `Dockerfile_generic`, and they are copied to a `Dockerfile` file and updated as appropriate for the ROS/Ubuntu version before `docker build` is called.
ARIAC 2018 only supports ROS Kinetic but the templates are still used.

At run-time, (after teams' Docker images have been created), `run_trial.bash` is the core script that starts the two containers.
The containers communicate using a Docker network.
The Gazebo server running in the ARIAC server container is configured to not accept communication from external clients such as the competitor container.
A custom version of the Gazebo-ROS interface that runs in the ARIAC server container is used, which does not expose ROS interfaces that can be used to interface with the simulator.
Only the ARIAC ROS interface is exposed.

A number of convenience scripts are provided for running the competition: see "Running the competition" below).

## Releasing a new version of ariac2 Docker images.

### 1. Build the base Docker images.

The most recent version of packages will be installed from `apt`.
Packages installed from `apt` include:
- `ariac2`
- `gazebo8`
- ROS packages except those in `gazebo_ros_pkgs`

The `gazebo_ros_pkgs` metapackage is built from source using [this branch specific to ARIAC](https://github.com/ros-simulation/gazebo_ros_pkgs/tree/ariac-network-kinetic).

```
./prepare_ariac_system.bash kinetic
```

### 2. Test using local images.

Replace references to `ariac/ariac2-*:latest` images with the local image name, where images are being used for (1) building team images and (2) running trials.

That is:
- `ariac/ariac2-competitor-base-${ROS_DISTRO_BUILD_TIME}:latest` -> `ariac-competitor-base-${ROS_DISTRO_BUILD_TIME}` in `ariac-competitior/build_competitor_image.bash`
- `ariac/ariac2-server-${ROS_DISTRO}:latest` -> `ariac-server-${ROS_DISTRO}` in `run_trial.bash`

```
./prepare_team_system.bash example_team
./run_trial.bash example_team sample
```

Confirm the ARIAC version running in the container is correct:
```
docker exec -it ariac-server-system /bin/bash
dpkg -s ariac2
```

### 3. Push the images to Dockerhub.

Configure Dockerhub credentials, then:

```
./push_dockerhub_images.bash <ariac_version> <gazebo_version
# e.g.:
# ./push_dockerhub_images.bash ariac2.1.4 gazebo_8.4
```

This will also update the `lastest` tag on Dockerhub images.


## Running the competition.

### 1. Fetch the latest Docker images.

Unless you're on the same computer that created the most recent `ariac2` Docker images, fetch them from Dockerhub.

```
./pull_dockerhub_images.bash
```

### 2. Download team systems.

Create a directory for each team in `team_config` and place their system's files in it, following the layout in `team_config/example_team`.

### 3. Prepare Docker images for all team systems.

```
./prepare_all_team_systems.bash
```

### 4. Download the trial config files.

All trial config files found in the `trial_config` directory will be used.
Ensure that `gazebo_state_logging: true` is in the options of the config files.

### 5. Run all trials for all teams.

```
./run_all_trials.bash
```

This will output results to the `logs` directory with the following structure:

```
logs
└── example_team  # team name
    └── sample  # trial name
        ├── gazebo
        │   └── state.log  # gazebo state log file
        ├── generated  # the specific files generated by gear.py based on team/trial config files
        │   ├── gear.launch
        │   ├── gear.urdf.xacro
        │   └── gear.world
        ├── performance.log  # scoring log file
        ├── ros  # ROS logs copied from ARIAC server container
        │   └── rosout.log
        └── ros-competitor  # ROS logs copied from competitor container
            └── example_node-1-stdout.log
```

### 6. Generate videos from Gazebo state logs.

```
./run_all_team_videos.bash
```

This will add a `video` directory to each trial found in the `logs` directory with a screen capture of the state log playback, e.g.:

```
logs
└── example_team
    └── sample
        ├── gazebo
        ├── generated
        ├── performance.log
        ├── ros
        ├── ros-competitor
        └── video
            └── example_team_sample.ogv
```

### 7. Re-run trials as necessary.

Before re-running any trials, copy the `logs` directory to one with another name.

All trials can be re-run for a single team using `./run_all_trials.bash example_team`.

All trials can be re-run for a set of teams by using `./run_all_teams.bash` after editing the `LIST_OF_TEAMS` variable in `run_all_teams.bash`.

A single trial can be re-run for all teams using `./run_all_teams.bash` after editing the `LIST_OF_TRIALS` variable in `run_all_trials.bash`.
